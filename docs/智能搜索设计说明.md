# 智能搜索设计说明

## 设计理念

**一个参数搞定所有搜索** - 让普通用户和专业人士都能轻松使用

## 核心特性

### 1. 自动分词
用户输入多个词，系统自动按空格分词：
```
输入: "皇马 巴黎圣日耳曼 淘汰赛 恢复能力"
分词: ["皇马", "巴黎圣日耳曼", "淘汰赛", "恢复能力"]
```

### 2. 全字段覆盖
每个词在**所有字段**中独立搜索：
- 标题 (title)
- 摘要 (summary)
- 关键词字段 (keywords)
- 内容 (content)

### 3. 宽松匹配 (OR关系)
- 多个词之间：**匹配任意一个即可**
- 单个词的多个字段：**匹配任意一个字段即可**

### 4. 结果最大化
尽可能返回更多相关内容，让用户自己筛选

## 使用示例

### 最简单 - 单个词
```python
search_news_tool(search="欧冠")
```

### 常用 - 多个词（自动分词）
```python
search_news_tool(search="皇马 巴黎圣日耳曼 淘汰赛 恢复能力")
```

### 精准 - 加来源筛选
```python
search_news_tool(search="AI 技术", source="科技日报")
```

### 专业 - 组合多个筛选
```python
search_news_tool(
    search="欧冠 英超 淘汰赛",
    source="体育周刊",
    event_name="2025/26赛季欧冠",
    start_date="2026-01-01",
    tags='["体育", "足球"]'
)
```

## 搜索逻辑详解

### 输入：`"皇马 巴黎 淘汰赛"`

### 分词后：`["皇马", "巴黎", "淘汰赛"]`

### SQL查询逻辑：
```sql
WHERE
    (
        (title LIKE '%皇马%' OR summary LIKE '%皇马%' OR keywords LIKE '%"皇马"%' OR content LIKE '%皇马%')
        OR
        (title LIKE '%巴黎%' OR summary LIKE '%巴黎%' OR keywords LIKE '%"巴黎"%' OR content LIKE '%巴黎%')
        OR
        (title LIKE '%淘汰赛%' OR summary LIKE '%淘汰赛%' OR keywords LIKE '%"淘汰赛"%' OR content LIKE '%淘汰赛%')
    )
    AND source = ?
    AND ...
```

### 解释：
- 3个词，每个词搜索4个字段 = 12个搜索条件
- 12个条件之间是 **OR** 关系
- 只要满足**任意一个**条件就返回该新闻
- 其他筛选条件（source、event_name等）是 **AND** 关系

## 实现细节

### 数据模型 (models.py)
```python
@dataclass
class SearchFilter:
    search_terms: Optional[List[str]] = None  # 搜索词列表
    source: Optional[str] = None
    event_name: Optional[str] = None
    # ...
```

### 数据库层 (database.py)
```python
# 智能搜索：每个词在所有字段中独立搜索（OR关系）
if filter.search_terms:
    term_conditions = []
    for term in filter.search_terms:
        term_pattern = f"%{term}%"
        # 每个词在4个字段中搜索
        term_conditions.append(f"""(
            title LIKE ? OR
            summary LIKE ? OR
            keywords LIKE ? OR
            content LIKE ?
        )""")
        params.extend([term_pattern, term_pattern, f'%"{term}"%', term_pattern])

    # 多个词之间是 OR 关系
    conditions.append(f"({' OR '.join(term_conditions)})")
```

### 接口层 (storage_tools.py)
```python
async def search_news_tool(search: Optional[str] = None, ...):
    # 自动分词
    search_terms = None
    if search:
        search_terms = [term.strip() for term in search.split() if term.strip()]

    # 构建过滤器
    search_filter = SearchFilter(search_terms=search_terms, ...)
```

## 优势对比

### 之前的设计 ❌
```python
# 普通用户困惑：用哪个？
search_news_tool(keyword="欧冠")           # 模糊搜索
search_news_tool(keywords='["欧冠"]')      # 精确搜索

# 参数冗余，功能重叠
search_news_tool(
    keyword="技术",
    keywords='["AI", "机器学习"]',  # 这两个到底怎么配合？
)
```

### 现在的设计 ✅
```python
# 普通用户：简单直接
search_news_tool(search="欧冠")
search_news_tool(search="皇马 巴黎 淘汰赛")

# 专业人士：组合筛选
search_news_tool(
    search="AI 技术 突破",
    source="科技日报",
    tags='["科技"]'
)
```

## 测试验证

运行测试脚本：
```bash
python scripts/test_smart_search.py
```

测试覆盖：
- ✅ 单个词搜索
- ✅ 多个词自动分词
- ✅ 全字段覆盖（标题、摘要、keywords、内容）
- ✅ OR关系匹配
- ✅ 组合筛选（search + source）
- ✅ keywords字段精确搜索

## 性能考虑

### 优点
- 宽松匹配，召回率高
- 用户不需要精确输入
- 一个参数解决所有场景

### 注意事项
- 可能返回较多结果，用户需要自行筛选
- 对于精确需求，可配合 source/event_name 等参数使用
- limit 参数控制返回数量（默认100）

## 适用场景

| 用户类型 | 使用方式 | 示例 |
|---------|---------|------|
| 普通用户 | 单个参数 | `search="欧冠"` |
| 普通用户 | 多个词 | `search="皇马 巴黎 淘汰赛"` |
| 专业人士 | 加来源 | `search="AI", source="科技日报"` |
| 专业人士 | 完整筛选 | `search="欧冠", source="体育", tags='["足球"]'` |

## 总结

这个设计实现了：
1. ✅ **简单**：一个 `search` 参数搞定
2. ✅ **智能**：自动分词、全字段覆盖
3. ✅ **宽松**：OR关系，结果最大化
4. ✅ **灵活**：支持专业精准筛选

**核心思想：让系统多做事，让用户少操心**
