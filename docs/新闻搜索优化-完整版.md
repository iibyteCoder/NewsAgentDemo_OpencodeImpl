# 新闻搜索优化完整报告

## 问题描述

原始设计存在以下问题：
1. ❌ `keyword` vs `keywords` - 参数太相似，用户和 LLM 都容易混淆
2. ❌ 功能重叠，不知道该用哪个
3. ❌ `keyword` 只搜索标题/摘要/内容，不搜索 keywords 字段
4. ❌ `keywords` 需要 JSON 格式，不够直观
5. ❌ 对用户和 LLM 都不友好

## 优化方案

### 核心理念
**一个智能参数 `search` 搞定所有搜索**

### 智能特性
1. **自动分词**：`"皇马 巴黎 淘汰赛"` → `["皇马", "巴黎", "淘汰赛"]`
2. **全字段覆盖**：标题、摘要、keywords字段、内容
3. **宽松匹配**：OR 关系，匹配任意一个词即可
4. **结果最大化**：尽可能返回相关内容

## 代码改动

### 1. 数据模型 (models.py)

```python
@dataclass
class SearchFilter:
    """搜索过滤器

    搜索逻辑：
    - search_terms: 每个词独立搜索（标题 OR 摘要 OR keywords字段 OR 内容）
    - 多个词之间是 OR 关系（匹配任意一个即可）
    - 所有字段都用模糊匹配（LIKE）
    """
    search_terms: Optional[List[str]] = None  # 搜索词列表（自动分词）
    source: Optional[str] = None
    event_name: Optional[str] = None
    # ... 其他筛选条件
```

### 2. 数据库层 (database.py)

```python
# 智能搜索：每个词在所有字段中独立搜索（OR关系）
if filter.search_terms:
    term_conditions = []
    for term in filter.search_terms:
        term_pattern = f"%{term}%"
        # 每个词在4个字段中搜索
        term_conditions.append(f"""(
            title LIKE ? OR
            summary LIKE ? OR
            keywords LIKE ? OR
            content LIKE ?
        )""")
        params.extend([term_pattern, term_pattern, f'%"{term}"%', term_pattern])

    # 多个词之间是 OR 关系
    conditions.append(f"({' OR '.join(term_conditions)})")
```

### 3. 接口层 (storage_tools.py)

```python
async def search_news_tool(
    search: Optional[str] = None,  # 单一智能参数
    source: Optional[str] = None,
    # ... 其他参数
) -> str:
    """搜索新闻 - 🔎 智能搜索，一个参数搞定所有"""

    # 自动分词：按空格分割搜索词
    search_terms = None
    if search:
        search_terms = [term.strip() for term in search.split() if term.strip()]
```

### 4. MCP 工具注册 (main.py) ⭐ **关键更新**

```python
@server.tool(name="news_storage_search")
async def search_news(
    search: str = None,  # ✅ 从 keyword 改为 search
    # ... 其他参数
) -> str:
    """搜索新闻 - 🔎 智能搜索，一个参数搞定所有

    【智能搜索特性】
    - 自动分词：多个空格分隔的词会被分别搜索
    - 全字段覆盖：搜索标题、摘要、keywords字段、内容
    - 宽松匹配：只要匹配任意一个词就返回（OR关系）
    - 结果最大化：尽可能多返回相关内容

    Examples:
        >>> search_news(search="欧冠")
        >>> search_news(search="皇马 巴黎圣日耳曼 淘汰赛")
    """
```

## 使用对比

### 之前的设计 ❌

```python
# 用户困惑：用哪个？
search_news(keyword="欧冠")
search_news(keywords='["欧冠", "英超"]')

# LLM 调用时的 MCP 描述
Args:
    keyword: 搜索关键词（模糊匹配标题、事件名称、摘要、内容）
    keywords: 关键词列表（精确匹配keywords字段）  # ❌ 已经不存在了
```

### 现在的设计 ✅

```python
# 简单直观
search_news(search="欧冠")
search_news(search="皇马 巴黎 淘汰赛")

# LLM 调用时的 MCP 描述
Args:
    search: 搜索词（支持多个词用空格分隔）
        - 单个词："欧冠"
        - 多个词："皇马 巴黎圣日耳曼 淘汰赛"
        - 系统会自动分词，每个词独立搜索所有字段
```

## 搜索逻辑详解

### 输入：`"皇马 巴黎 淘汰赛"`

### 处理流程：
1. **自动分词** → `["皇马", "巴黎", "淘汰赛"]`
2. **构建查询**：
   ```sql
   WHERE
       (
           (title LIKE '%皇马%' OR summary LIKE '%皇马%' OR keywords LIKE '%"皇马"%' OR content LIKE '%皇马%')
           OR
           (title LIKE '%巴黎%' OR summary LIKE '%巴黎%' OR keywords LIKE '%"巴黎"%' OR content LIKE '%巴黎%')
           OR
           (title LIKE '%淘汰赛%' OR summary LIKE '%淘汰赛%' OR keywords LIKE '%"淘汰赛"%' OR content LIKE '%淘汰赛%')
       )
   ```
3. **OR 关系**：3个词 × 4个字段 = 12个条件，满足任意一个即可

## 测试验证

### 测试脚本
[scripts/test_smart_search.py](scripts/test_smart_search.py)

### 测试结果 ✅
- ✅ 单个词搜索
- ✅ 多个词自动分词
- ✅ 全字段覆盖（标题、摘要、keywords、内容）
- ✅ OR关系匹配
- ✅ 组合筛选（search + source）
- ✅ keywords字段精确搜索

### 测试数据
```python
测试输入："皇马 巴黎 淘汰赛"
预期结果：应包含所有匹配任意一个词的新闻
实际结果：✅ 返回10条相关新闻
```

## 对用户的价值

### 普通用户
```python
# 最简单：一个词
search_news(search="欧冠")

# 常用：多个词
search_news(search="皇马 巴黎 淘汰赛")

# 精准：加来源
search_news(search="AI", source="科技日报")
```

### 专业人士
```python
# 组合多个筛选条件
search_news(
    search="欧冠 英超 淘汰赛",
    source="体育周刊",
    event_name="2025/26赛季欧冠",
    tags='["体育", "足球"]',
    start_date="2026-01-01"
)
```

### LLM (Claude 等)
- ✅ 看到 `search` 参数，理解这是一个智能搜索
- ✅ 知道可以用空格分隔多个词
- ✅ 知道可以配合其他筛选条件
- ✅ 不会被 `keyword` vs `keywords` 困惑

## 性能考虑

### 优点
- 宽松匹配，召回率高
- 用户不需要精确输入
- 一个参数解决所有场景

### 注意事项
- 可能返回较多结果，用户需要自行筛选
- 对于精确需求，可配合 source/event_name 等参数
- `limit` 参数控制返回数量（默认100）

## 文件清单

### 核心修改
- [mcp_server/news_storage/core/models.py](mcp_server/news_storage/core/models.py#L121-L138) - 数据模型
- [mcp_server/news_storage/core/database.py](mcp_server/news_storage/core/database.py#L252-L268) - 搜索逻辑
- [mcp_server/news_storage/tools/storage_tools.py](mcp_server/news_storage/tools/storage_tools.py#L256-L369) - 接口实现
- [mcp_server/news_storage/main.py](mcp_server/news_storage/main.py#L176-L238) - MCP 工具注册 ⭐

### 测试文件
- [scripts/test_smart_search.py](scripts/test_smart_search.py) - 智能搜索测试

### 文档
- [docs/智能搜索设计说明.md](docs/智能搜索设计说明.md) - 设计文档

## 验证步骤

1. **代码验证**
   ```bash
   python scripts/test_smart_search.py
   ```

2. **MCP 服务器验证**
   ```bash
   python -c "from mcp_server.news_storage.main import server; print('OK')"
   ```

3. **LLM 调用验证**
   - 启动 MCP 服务器
   - 在 Claude 中调用 `news_storage_search`
   - 确认参数描述正确

## 总结

### 改进点
1. ✅ 简化参数：从 `keyword` + `keywords` → 单一 `search`
2. ✅ 自动分词：空格分隔，无需手动构建 JSON
3. ✅ 全字段覆盖：包括 keywords 字段
4. ✅ 宽松匹配：OR 关系，结果最大化
5. ✅ 更新 MCP 描述：让 LLM 正确理解工具

### 设计原则
- **让系统多做事，让用户少操心**
- **简单而强大**
- **对人类和 AI 都友好**

### 下一步
- 监控实际使用情况
- 收集用户反馈
- 根据需要调整匹配策略
