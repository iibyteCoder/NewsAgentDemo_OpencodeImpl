# 智能体架构优化说明

## 优化日期
2026-01-29

## 问题背景

在B级需求中，用户需要同时查询多个类型的新闻（如"体育运动和国际政治"）。原架构在处理多个类别时存在以下问题：

### 问题1：任务调度失败

**现象**：
- 单个类别查询正常工作
- 多个类别查询时卡在第二层任务

**根因**：
```
旧架构：
news-collector (primary agent)
  ├─ 分解用户需求为类别：["体育", "政治"]
  ├─ 为每个类别启动Task
  └─ Task被系统分配给general agent ❌
      └─ general没有正确的prompt配置
          └─ 无法正确执行 → 卡住
```

### 问题2：角色混淆

- `news-collector`既是编排器又是执行者
- 职责过多，逻辑复杂
- Prompt中包含了大量流程控制指令

### 问题3：不符合OpenCode Agent设计原则

根据[OpenCode Agent文档](docs/opencode_docs/agents.mdx)：
- **Primary agent**：主要的交互智能体
- **Subagent**：通过Task工具调用的专门智能体
- **General**：当没有明确指定agent时使用的默认subagent

旧架构没有正确利用subagent机制。

---

## 优化方案

### 新架构：三层清晰分工

```
┌─────────────────────────────────────────────────┐
│ Layer 1: Orchestrator (Primary Agent)           │
│ 职责：接收用户需求 → 分解为类别 → 并发调度       │
└─────────────────────────────────────────────────┘
                      ↓ 并发启动（使用subagent_type明确指定）
┌─────────────────────────────────────────────────┐
│ Layer 2: Category-Processor (Subagent)          │
│ 职责：处理单个类别的完整流程                      │
│ - 搜索新闻 → 聚合事件 → 处理事件 → 生成报告      │
└─────────────────────────────────────────────────┘
                      ↓ 调用subagent
┌─────────────────────────────────────────────────┐
│ Layer 3: Event Subagents (Hidden Subagents)     │
│ - event-aggregator: 聚合新闻为事件               │
│ - event-processor: 处理单个事件（并发调用分析）   │
│ - validator/timeline-builder/predictor: 分析    │
│ - synthesizer: 生成报告                          │
└─────────────────────────────────────────────────┘
```

### 核心改进

#### 1. 新增 Orchestrator 智能体（Primary Agent）

**文件**：[.opencode/agents/orchestrator.md](.opencode/agents/orchestrator.md)

**唯一职责**：
- 分解用户需求为类别列表
- 为每个类别启动独立的category-processor Task
- 等待所有类别完成
- 生成总索引

**关键特性**：
- ✅ 明确使用 `subagent_type="category-processor"` 指定subagent
- ✅ 所有类别Task同时启动（完全并发）
- ✅ 不执行具体任务，只负责调度

#### 2. 新增 Category-Processor 智能体（Subagent）

**文件**：[.opencode/agents/category-processor.md](.opencode/agents/category-processor.md)

**唯一职责**：
- 处理单个类别的完整流程
- 搜索今日新闻 → 聚合事件 → 并发处理事件 → 生成报告

**关键特性**：
- ✅ 作为subagent，可以正确继承orchestrator的调用意图
- ✅ 每个类别独立执行，互不干扰
- ✅ 使用 `subagent_type` 明确调用手任务

#### 3. 保留原有 Event Subagents

以下subagent保持不变，继续使用：
- `event-aggregator`：聚合新闻为事件
- `event-processor`：处理单个事件（并发调用validator/timeline-builder/predictor）
- `validator`：验证事件真实性
- `timeline-builder`：构建事件时间轴
- `predictor`：预测事件发展趋势
- `synthesizer`：生成最终报告

---

## 使用方法

### 切换到 Orchestrator

在VSCode中：
1. 使用快捷键切换到orchestrator agent
2. 或在命令面板中选择"orchestrator"智能体

### 输入示例

#### 单个类别
```text
帮我收集体育运动相关新闻
```

#### 多个类别（B级需求）
```text
帮我收集体育运动和国际政治相关新闻
```

#### 更多类别
```text
收集科技、经济、娱乐、体育新闻
```

### 执行流程

```
用户输入："收集体育和政治新闻"
    ↓
Orchestrator识别类别：["体育", "政治"]
    ↓
Orchestrator并发启动2个Task：
    ├─ Task(category-processor, "体育")
    └─ Task(category-processor, "政治")
    ↓ (完全并发)
    ├─ Category-Processor(体育) 执行完整流程
    │   ├─ 搜索体育新闻
    │   ├─ 聚合为事件
    │   ├─ 并发处理所有事件
    │   └─ 生成体育报告
    │
    └─ Category-Processor(政治) 执行完整流程
        ├─ 搜索政治新闻
        ├─ 聚合为事件
        ├─ 并发处理所有事件
        └─ 生成政治报告
    ↓
Orchestrator等待完成，生成总索引
    ↓
输出：./output/report_YYYYMMDD_HHMMSS/
    ├── 体育/
    ├── 政治/
    └── 总索引.md
```

---

## 性能提升

### 旧架构（串行）
```
处理3个类别 × 5个事件/类别 × 3种分析
= 串行执行
总耗时 = 所有任务的耗时之和
```

### 新架构（三层并发）
```
类别级并发：3个类别同时处理
  ↓
事件级并发：每个类别内的5个事件同时处理
  ↓
分析级并发：每个事件的3种分析同时执行

总耗时 = max(最慢单个事件的分析耗时)
```

**理论加速比**：类别数 × 事件数（例如：3 × 5 = 15倍加速）

---

## 配置文件变更

### opencode.json

新增配置：

```json
{
  "agent": {
    "orchestrator": {
      "mode": "primary",
      "description": "新闻收集编排器 - 分解需求并调度类别处理器（推荐使用）",
      "prompt": "{file:.opencode/agents/orchestrator.md}",
      "tools": {
        "write": true,
        "read": true,
        "task": true
      },
      "permission": {
        "task": {
          "category-processor": "allow"
        }
      }
    },
    "category-processor": {
      "mode": "subagent",
      "description": "类别处理器 - 处理单个新闻类别的完整流程",
      "prompt": "{file:.opencode/agents/category-processor.md}",
      "maxSteps": 30,
      "tools": {
        "write": true,
        "read": true,
        "web-browser_*": true,
        "news-storage*": true,
        "task": true
      }
    }
  }
}
```

### 新增文件

1. **[.opencode/agents/orchestrator.md](.opencode/agents/orchestrator.md)**
   - Orchestrator智能体的配置文件
   - 包含任务编排逻辑和最佳实践

2. **[.opencode/agents/category-processor.md](.opencode/agents/category-processor.md)**
   - Category-Processor智能体的配置文件
   - 包含单个类别的完整处理流程

### 保留文件

- `news-collector`：标记为已弃用，保留以向后兼容
- 所有event subagent：保持不变

---

## 关键技术点

### 1. 明确指定Subagent类型

**正确** ✅：
```python
Task(
    description="处理体育类别",
    subagent_type="category-processor",  # 明确指定
    prompt="处理类别：体育"
)
```

**错误** ❌：
```python
Task(
    description="处理体育类别",
    prompt="处理类别：体育"  # 缺少subagent_type，系统分配给general
)
```

### 2. 并发启动多个Task

**正确** ✅：
```python
# 同时启动所有Task（并发执行）
for category in categories:
    Task(
        description=f"处理{category}类别",
        subagent_type="category-processor",
        prompt=f"处理类别：{category}"
    )
# 系统自动管理并发
```

**错误** ❌：
```python
# 串行启动
for category in categories:
    task = Task(...)
    result = task.result  # 等待完成才启动下一个
```

### 3. 最小上下文传递

**正确** ✅：
```python
Task(
    description="处理事件",
    subagent_type="event-processor",
    prompt="处理事件:'事件名称'"  # 只传递事件名称
)
# event-processor从数据库读取详细数据
```

**错误** ❌：
```python
Task(
    description="处理事件",
    prompt=f"""
    处理事件，以下是所有数据：
    {大量新闻数据}
    {分析结果}
    ...
    """  # 传递大量上下文，浪费token
)
```

---

## 迁移指南

### 对于现有用户

1. **切换到orchestrator**
   - 在VSCode中使用快捷键切换agent
   - 或在设置中将默认primary agent改为orchestrator

2. **使用方式不变**
   - 输入同样的自然语言指令
   - 系统自动分解为多个类别并并发处理

3. **性能提升**
   - 多类别查询速度显著提升
   - 不再出现卡住问题

### 对于开发者

1. **查看新架构**
   - [.opencode/agents/orchestrator.md](.opencode/agents/orchestrator.md)
   - [.opencode/agents/category-processor.md](.opencode/agents/category-processor.md)

2. **理解关键改进**
   - 明确使用 `subagent_type` 参数
   - 三层并发架构
   - 职责清晰分离

3. **扩展建议**
   - 添加新的subagent时，遵循相同的模式
   - 使用明确的 `subagent_type` 调用
   - 保持subagent职责单一

---

## 测试验证

### 单类别测试
```text
帮我收集体育运动相关新闻
```

**预期**：
- 搜索体育新闻
- 聚合为事件
- 并发处理所有事件
- 生成报告

### 多类别测试（B级需求）
```text
帮我收集体育运动和国际政治相关新闻
```

**预期**：
- Orchestrator识别2个类别
- 并发启动2个Category-Processor
- 每个类别独立执行完整流程
- 生成总索引

### 复杂测试
```text
收集科技、经济、娱乐、体育新闻
```

**预期**：
- 并发处理4个类别
- 显著的性能提升
- 所有报告正确生成

---

## 常见问题

### Q1: 为什么不继续使用news-collector？

A: news-collector存在架构问题：
- 角色混淆（既是编排器又是执行者）
- 多类别时会卡住（Task被分配给general）
- 不符合OpenCode的agent设计最佳实践

### Q2: orchestrator和category-processor的区别？

A:
- **orchestrator (primary)**：分解需求并调度，不执行具体任务
- **category-processor (subagent)**：执行单个类别的完整流程

### Q3: 如何确保Task被分配给正确的subagent？

A: 使用 `subagent_type` 参数明确指定：
```python
Task(
    description="...",
    subagent_type="category-processor",  # 关键参数
    prompt="..."
)
```

### Q4: 性能提升有多大？

A: 理论加速比 = 类别数 × 事件数
- 2个类别 × 5个事件 = 10倍加速
- 3个类别 × 10个事件 = 30倍加速

实际加速比取决于：
- 网络IO并发能力
- API速率限制
- 系统资源

### Q5: 旧的news-collector还能用吗？

A: 可以，但已标记为弃用：
- 不推荐继续使用
- 单类别查询可能正常
- 多类别查询会卡住
- 建议切换到orchestrator

---

## 总结

### 核心改进

1. **架构清晰化**：三层架构，职责明确
2. **问题修复**：解决多类别卡住问题
3. **性能提升**：三层并发，显著加速
4. **最佳实践**：符合OpenCode agent设计原则

### 关键技术

1. **明确指定subagent_type**：避免Task被分配给general
2. **完全并发执行**：类别级、事件级、分析级并发
3. **最小上下文传递**：只传递事件名称，数据从数据库读取
4. **职责单一化**：每个agent只做一件事

### 使用建议

1. **使用orchestrator**：作为primary agent处理用户需求
2. **明确指定subagent**：使用 `subagent_type` 参数
3. **并发启动Task**：不要串行等待
4. **保持简单**：每个agent职责单一，prompt简洁

---

## 文件清单

### 新增文件
- [.opencode/agents/orchestrator.md](.opencode/agents/orchestrator.md)
- [.opencode/agents/category-processor.md](.opencode/agents/category-processor.md)
- [docs/智能体架构优化说明.md](docs/智能体架构优化说明.md)

### 修改文件
- [opencode.json](opencode.json) - 新增orchestrator和category-processor配置

### 保留文件（未修改）
- [.opencode/agents/event-aggregator.md](.opencode/agents/event-aggregator.md)
- [.opencode/agents/event-processor.md](.opencode/agents/event-processor.md)
- [.opencode/agents/validator.md](.opencode/agents/validator.md)
- [.opencode/agents/timeline-builder.md](.opencode/agents/timeline-builder.md)
- [.opencode/agents/predictor.md](.opencode/agents/predictor.md)
- [.opencode/agents/synthesizer.md](.opencode/agents/synthesizer.md)
- [prompts/news-collector.txt](prompts/news-collector.txt) - 标记为已弃用

---

## 联系方式

如有问题或建议，请通过以下方式联系：
- 提交Issue到项目仓库
- 查看文档：[docs/](docs/)
- 参考OpenCode文档：[docs/opencode_docs/](docs/opencode_docs/)
