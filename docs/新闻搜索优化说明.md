# 新闻搜索优化说明

## 问题描述

之前的搜索接口存在设计不一致的问题：

1. **存储层面**：关键词是独立存储的列表（如 `["欧冠", "英超", "淘汰赛"]`）
2. **搜索层面**：
   - 只支持单个字符串参数 `keyword`（如 `"英超 欧冠 2026 冠军"`）
   - 且不搜索数据库中的 `keywords` 字段，只搜索标题/摘要/内容
   - 这不符合直觉且功能受限

## 优化方案

### 1. 新增 `keywords` 参数

在 `search_news_tool` 中新增 `keywords` 参数：
- **类型**：JSON 字符串（如 `'["欧冠", "英超"]'`）
- **作用**：精确匹配数据库中存储的 `keywords` 字段
- **匹配逻辑**：只要新闻包含列表中的**任意一个**关键词即匹配（OR 关系）

### 2. 保留 `keyword` 参数

- **类型**：字符串
- **作用**：全文模糊搜索（标题、事件名称、摘要、内容）
- **用途**：用于不精确的全文搜索场景

### 3. 参数对比

| 参数 | 类型 | 搜索范围 | 匹配方式 | 使用场景 |
|------|------|---------|---------|---------|
| `keyword` | 字符串 | 标题、事件名称、摘要、内容 | 模糊匹配（LIKE） | 全文搜索 |
| `keywords` | JSON 数组 | keywords 字段 | 精确匹配（任意一个） | 按标签/关键词筛选 |

## 使用示例

### 示例1：精确关键词搜索（推荐）

```python
# 搜索包含"欧冠"或"英超"关键词的新闻
search_news_tool(
    keywords='["欧冠", "英超"]',
    limit=10
)
```

### 示例2：全文模糊搜索

```python
# 在标题、摘要中搜索"淘汰赛"
search_news_tool(
    keyword="淘汰赛",
    limit=10
)
```

### 示例3：组合搜索

```python
# 同时使用全文搜索和关键词筛选
search_news_tool(
    keyword="技术",           # 全文搜索
    keywords='["AI", "机器学习"]',  # 精确关键词
    source="科技日报",
    limit=50
)
```

## 代码改动

### 1. models.py - 添加 `keywords` 字段

```python
@dataclass
class SearchFilter:
    keyword: Optional[str] = None  # 全文搜索
    keywords: Optional[List[str]] = None  # 关键词精确搜索
    # ... 其他字段
```

### 2. database.py - 添加 keywords 搜索逻辑

```python
# 关键词列表搜索（精确匹配 keywords 字段）
if filter.keywords:
    keyword_conditions = []
    for kw in filter.keywords:
        keyword_conditions.append("keywords LIKE ?")
        params.append(f'%"{kw}"%')
    # 只要包含任意一个关键词即可（OR 条件）
    conditions.append(f"({' OR '.join(keyword_conditions)})")
```

### 3. storage_tools.py - 更新接口文档

- 新增 `keywords` 参数
- 更新文档说明两者的区别
- 添加使用示例

## 优势

1. **符合直觉**：存储是列表，搜索也用列表
2. **功能增强**：可以精确匹配关键词字段
3. **灵活组合**：可以同时使用全文搜索和关键词筛选
4. **向后兼容**：保留原有的 `keyword` 参数

## 测试

运行测试脚本验证功能：

```bash
python scripts/test_search_keywords.py
```

测试覆盖：
- ✅ 单个关键词精确搜索
- ✅ 多个关键词 OR 搜索
- ✅ 全文模糊搜索
- ✅ 组合搜索
- ✅ 数据存储和清理

## 注意事项

1. `keywords` 参数使用 JSON 字符串格式
2. 匹配是 OR 关系（任意一个关键词匹配即可）
3. 与 `keyword` 参数可以同时使用（AND 关系）
4. JSON 字符串中的关键词需要用双引号包裹
